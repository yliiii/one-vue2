import path from 'path'
import MFS from 'memory-fs'
import { ROOT_PATH, CLIENT_PATH } from 'server-bin/config/path'


const ENV = process.env.NODE_ENV
const CLIENT = process.env.CLIENT
const clientWebpackConfig = require(path.resolve(CLIENT_PATH, 'build/webpack.client.development')).default
const serverWebpackConfig = require(path.resolve(CLIENT_PATH, 'build/webpack.server.development')).default

export default function setupDevServer (app, cb = () => null) {
  let bundle
  let clientManifest
  let resolve
  const readyPromise = new Promise(r => { resolve = r })
  const ready = (...args) => {
    cb(...args)
    resolve()
  }
  const readFileFromWebpackDist = (fs, file) => {
    try {
      return fs.readFileSync(path.join(clientWebpackConfig.output.path, file), 'utf-8')
    } catch (e) {}
  }

  // webpack compiler
  const webpack = require('webpack')

  // webpack client compiler
  const clientCompiler = webpack(clientWebpackConfig)
  // webpack dev server middleware
  const webpackDevMiddleware = require('webpack-dev-middleware')
  const devMiddlewareInstance = webpackDevMiddleware(clientCompiler, {
    noInfo: true,
    quiet: true,
    watchOptions: {
      aggregateTimeout: 300,
      poll: true
    },
    publicPath: clientWebpackConfig.output.publicPath,
    stats: {
      colors: true
    }
  })
  // add dev server middleware
  app.use((function(devMiddleware) {
    return async (ctx, next) => {
      await devMiddleware(ctx.req, {
        end: function(content) {
          return ctx.body = content
        },
        setHeader: function (name, value) {
          return ctx.set(name, value)
        }
      }, next)
    }
  })(devMiddlewareInstance))
  clientCompiler.plugin('done', stats => {
    stats = stats.toJson()
    stats.errors.forEach(err => console.error(err))
    stats.warnings.forEach(err => console.warn(err))

    if (stats.errors.length) return

    clientManifest = readFileFromWebpackDist(
      devMiddlewareInstance.fileSystem,
      'vue-ssr-client-manifest.json'
    )
    clientManifest = JSON.parse(clientManifest)

    if (bundle) {
      ready(bundle, {
        clientManifest
      })
    }
  })

  // hot middleware
  const KWM = require('koa-webpack-middleware')
  const hotMiddleware = KWM.hotMiddleware
  const hotMiddlewareInstance = hotMiddleware(clientCompiler, {
    log: console.log,
    path: '/__webpack_hmr',
    heartbeat: 10 * 1000
  })
  // add hot middleware
  app.use(hotMiddlewareInstance)

  // webpack server compiler
  const serverCompiler = webpack(serverWebpackConfig)
  const mfs = new MFS()
  serverCompiler.outputFileSystem = mfs
  serverCompiler.watch({}, (err, stats) => {
    if (err) throw err

    stats = stats.toJson()
    if (stats.errors.length) return

    // read bundle generated by vue-ssr-webpack-plugin
    bundle = JSON.parse(readFileFromWebpackDist(mfs, 'vue-ssr-server-bundle.json'))

    if (clientManifest) {
      ready(bundle, {
        clientManifest
      })
    }
  })

  return readyPromise
}
